<html>

<head>
    <meta charset="utf-8">
    <title>数据可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    <style>
        body {
            text-align: center;
        }
    </style>

    <!-- Styles -->
    <style>
        #chartdiv {
            width: 100%;
            /* height: 80%; */
            height:calc(100vh - 130px); 
            /* padding-top: 20%; */
            /* margin-bottom: 25px; */
            position: relative;
        }

        .slogn {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 12px;
            z-index: 2000;
            color: #aaa
        }
        * {
            padding: 0;
            margin: 0;
        }
    </style>

    <!-- Resources -->
    <script src="//cdn.amcharts.com/lib/4/core.js"></script>
    <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="//cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
    <script src="//cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PEPQ7KZ023"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-PEPQ7KZ023');
    </script>
</head>

<body>
    <a class="slogn" target="_blank" href="https://github.com/xiami2021/backup">github.com/xiami2021/backup</a>
    <div id="app">
        <div v-if="loading">loading...</div>
        <div id="chartdiv"></div>
        <div style="text-align: left; margin-top: 10px; padding: 10px 20px; background: #f4f4f4;">
            <img src="qrcode.png" style="vertical-align: middle; margin-right: 15px;" height="100"/>
            生成虾米音乐收藏歌曲Tag云
        </div>
    </div>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                loading: true,
                songs: null,
                topStyles: []
            },
            mounted() {
                var data = 'http://localhost:8765/downloader/analytics?all=1'
                this.loadData();
                // axios.get('http://localhost:8765/api/callAPI', { params: {
                //     action:  JSON.stringify({
                //         method: 'mtop.alimusic.music.list.collectservice.getcollectbyuser',
                //         needToken: true,
                //         args: {
                //             userId: '3096251',
                //             pagingVO: {
                //                 page: 1,
                //                 pageSize: 100
                //             }
                //         }
                //     })
                // }})
            },
            methods: {
                draw() {
                    this.loading = false;
                    var self = this;
                    // this.$refs.main.width = window.innerWidth
                    // this.$refs.main.height = window.innerHeight
                    am4core.ready(function () {
                        am4core.useTheme(am4themes_animated);
                        // Themes end
                        var chart = am4core.create("chartdiv", am4plugins_wordCloud.WordCloud);
                        var series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());
                        series.accuracy = 4;
                        series.step = 30;
                        series.rotationThreshold = 0.4;
                        series.maxCount = 400;
                        series.minWordLength = 2;
                        series.labels.template.tooltipText = "{word}: {value}";
                        series.fontFamily = "Courier New";
                        series.maxFontSize = am4core.percent(20);
                        series.data = self.topStyles.map(_ => {
                            return {
                                // tag: _.name,
                                tag: _.name_cn,
                                weight: _.count
                            }
                        });
                        series.dataFields.word = "tag";
                        series.dataFields.value = "weight";
                        console.log('series', series)
                    }); // end am4core.ready()
                    // WordCloud(document.getElementById('my_canvas'), {
                    //     gridSize: Math.round(16 * window.innerWidth / 1024),
                    //     weightFactor: function (size) {
                    //         return Math.pow(size, 2.3) * window.innerWidth / 1024;
                    //     },
                    //     fontFamily: 'Times, serif',
                    //     color: function (word, weight) {
                    //         return (weight === 12) ? '#f02222' : '#c09292';
                    //     },
                    //     rotateRatio: 0.5,
                    //     rotationSteps: 2,
                    //     backgroundColor: '#ffe0e0',
                    //     list: this.topStyles.map(_ => {
                    //         return [_.name, _.count]
                    //     })
                    // });
                    // chart.marginBottom = 10
                },
                async loadData() {
                    const { data } = await axios.get('http://localhost:8765/downloader/analytics?all=1')
                    this.songs = data.filter(_ => _.raw).map(_ => {
                        return JSON.parse(_.raw)
                    })
                    var byStyles = {};
                    const topStyles = {};
                    const styleMeta = {};
                    for (let index = 0; index < this.songs.length; index++) {
                        const rawData = this.songs[index];
                        if (!rawData.styles) continue;
                        rawData.styles.forEach((_) => {
                            styleMeta[_.styleName] = _;
                            topStyles[_.styleName] = topStyles[_.styleName] || 0;
                            topStyles[_.styleName]++;
                        });
                    }
                    function getTop() {
                        return Object.keys(topStyles).sort(function (a, b) {
                            return topStyles[b] - topStyles[a]
                        }).map(_ => {
                            var pairs = _.split(" ");
                            var cnName = pairs.shift();
                            return {
                                rawName: _,
                                name: pairs.join(" "),
                                name_cn: cnName,
                                meta: styleMeta[_],
                                count: topStyles[_]
                            }
                        })
                    }
                    var topStylesRaw = getTop();
                    console.log('topStylesRaw', topStylesRaw)
                    this.topStyles = topStylesRaw
                    this.draw();
                }
            },
        })


    </script>
</body>

</html>
